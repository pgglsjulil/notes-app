{% extends "layout.html" %}

{% block title %}
    {% if note %}
        Edit Note: {{ note.title }}
    {% else %}
        Create New Note
    {% endif %}
{% endblock %}

{% block content %}
    <div class="note-form-container">
        {# Memberi ID pada form dan mengubah action untuk POST saja, bukan dua kondisi #}
        <form id="noteForm" method="POST" action="
            {% if note %}
                {{ url_for('main.edit_note', note_id=note.id) }}
            {% else %}
                {{ url_for('main.create_note') }}
            {% endif %}
        ">
            {# Tombol "Close" yang akan memicu penyimpanan AJAX #}
            <button type="button" class="close-btn" id="closeButton">
                &times; 
            </button>

            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" 
                       value="{{ note.title if note else '' }}" 
                       placeholder="Enter note title" required>
            </div>

            <div class="form-group">
                <label for="content">Content:</label>
                <textarea id="content" name="content" 
                          placeholder="Start writing your note here..." 
                          rows="15" required>{{ note.content if note else '' }}</textarea>
            </div>

            {# Tombol "Save Note" tetap ada untuk submit manual jika diinginkan #}
            <button type="submit" class="save-note-btn">
                {% if note %}
                    Update Note
                {% else %}
                    Create Note
                {% endif %}
            </button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const noteForm = document.getElementById('noteForm');
            const closeButton = document.getElementById('closeButton');
            const titleInput = document.getElementById('title');
            const contentTextarea = document.getElementById('content');
            
            let isDirty = false;

            titleInput.addEventListener('input', () => { isDirty = true; });
            contentTextarea.addEventListener('input', () => { isDirty = true; });

            async function saveNote() {
                if (!isDirty && "{{ note.id if note else '' }}" === '') { 
                    console.log("No changes and new note is empty, not saving.");
                    return true; 
                }

                const formData = new FormData(noteForm);
                const title = formData.get('title');
                const content = formData.get('content');

                if (!title || !content) {
                    alert('Title and content cannot be empty!');
                    return false; 
                }

                try {
                    const response = await fetch(noteForm.action, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json(); 
                        console.log('Note saved successfully:', data);
                        isDirty = false;
                        if ("{{ note.id if note else '' }}" === '' && data.note_id) {
                            noteForm.action = "{{ url_for('main.edit_note', note_id=0) }}".replace('0', data.note_id);
                        }
                        return true;
                    } else {
                        const errorData = await response.json();
                        console.error('Failed to save note:', errorData);
                        alert('Failed to save note: ' + (errorData.message || 'Unknown error'));
                        return false; 
                    }
                } catch (error) {
                    console.error('Network error during save:', error);
                    alert('Network error: Could not connect to server.');
                    return false; 
                }
            }

            closeButton.addEventListener('click', async () => {
                const saved = await saveNote();
                if (saved) {
                    window.location.href = "{{ url_for('main.home') }}#notes";
                }
            });

            document.addEventListener('keydown', async (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault(); 
                    await saveNote();
                    flash('Note saved!', 'success'); 
                }
            });

            window.addEventListener('beforeunload', (event) => {
                if (isDirty) {
                    event.preventDefault();
                    event.returnValue = ''; 
                }
            });
        });
    </script>
{% endblock %}